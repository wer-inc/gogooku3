# å­¦ç¿’å‡¦ç†ç¢ºèªã‚µãƒãƒªãƒ¼ - 2025-11-03

## ğŸ” å®Ÿæ–½ã—ãŸç¢ºèªå†…å®¹

### 1ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ âœ…

**çµæœ**:
- Dataset: `output/ml_dataset_latest_clean.parquet`
- Shape: **4,643,854 rows Ã— 404 columns**
- Featureåˆ—: NaNç‡ 1-2%ï¼ˆè¨±å®¹ç¯„å›²å†…ï¼‰

### 2ï¸âƒ£ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ—ã®ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª ğŸš¨ â†’ âœ… ä¿®æ­£

**ç™ºè¦‹ã—ãŸå•é¡Œ**:
- âŒ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã« `horizon_1, horizon_5, horizon_10, horizon_20` åˆ—ãŒå­˜åœ¨ã—ãªã„
- âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ `target_column: target` ã¨ãªã£ã¦ã„ãŸ
- âœ… å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«ã¯ `feat_ret_1d, feat_ret_5d, feat_ret_10d, feat_ret_20d` ãŒå­˜åœ¨

**æ ¹æœ¬åŸå› **:
```yaml
# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¿®æ­£å‰ï¼‰
target_column: target            # â† é–“é•ã„
target_columns:
  - target_1d                    # â† ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«å­˜åœ¨ã—ãªã„
  - target_5d
  - target_10d
  - target_20d
```

**ä¿®æ­£å†…å®¹**:
```yaml
# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¿®æ­£å¾Œï¼‰
target_column: feat_ret         # â† ä¿®æ­£
target_columns:
  - feat_ret_1d                 # â† ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®å®Ÿéš›ã®åˆ—åã«åˆã‚ã›ãŸ
  - feat_ret_5d
  - feat_ret_10d
  - feat_ret_20d
```

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `configs/atft/data/jpx_large_scale.yaml`

### 3ï¸âƒ£ ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª âœ…

**ç¢ºèªçµæœ**:
- âœ… `BYPASS_GAT_COMPLETELY`: æœªè¨­å®šï¼ˆGATã¯æœ‰åŠ¹ï¼‰
- âœ… `ADV_GRAPH_TRAIN=1`: ã‚°ãƒ©ãƒ•å­¦ç¿’æœ‰åŠ¹
- âœ… `NUM_WORKERS=12`: ãƒãƒ«ãƒãƒ¯ãƒ¼ã‚«ãƒ¼æœ‰åŠ¹
- âœ… `USE_CACHE=1`: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹

### 4ï¸âƒ£ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ—ãƒ­ãƒ¼ãƒ‰æ¤œè¨¼ âœ…

éå»ã®ãƒ­ã‚°ã‹ã‚‰ç¢ºèªï¼š
```
Target horizon_1: mean=0.000763, std=0.008553  âœ…
Target horizon_5: mean=0.004600, std=0.019692  âœ…
Target horizon_10: mean=0.011444, std=0.022506 âœ…
Target horizon_20: mean=0.022997, std=0.027307 âœ…
```

â†’ **ä¿®æ­£å¾Œã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ—ãŒæ­£ã—ããƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼**

---

## ğŸš¨ æ¤œå‡ºã•ã‚ŒãŸé‡å¤§ãªå•é¡Œ

### å•é¡Œ1: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ—åã®ãƒŸã‚¹ãƒãƒƒãƒï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰

**ç—‡çŠ¶**:
- ãƒ¢ãƒ‡ãƒ«ãŒå®šæ•°äºˆæ¸¬ï¼ˆ`yhat_std=0.0`ï¼‰
- ã€ŒNo matching horizons foundã€ã‚¨ãƒ©ãƒ¼

**åŸå› **:
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ—åã¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®å®Ÿéš›ã®åˆ—åãŒä¸€è‡´ã—ã¦ã„ãªã‹ã£ãŸ

**ä¿®æ­£**:
`configs/atft/data/jpx_large_scale.yaml` ã‚’ä¿®æ­£

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **ä¿®æ­£å®Œäº†**

---

### å•é¡Œ2: äºˆæ¸¬è¾æ›¸ã®æŠ½å‡ºãƒŸã‚¹ï¼ˆ11æœˆ3æ—¥ã«ä¿®æ­£æ¸ˆã¿ï¼‰

**ç—‡çŠ¶**:
```
[ERROR] No matching horizons found in predictions/targets; returning zero loss.
```

**åŸå› **:
`train_epoch()` ã§ `_reshape_to_batch_only()` ã«èª¤ã£ãŸdictæ§‹é€ ã‚’æ¸¡ã—ã¦ã„ãŸ
- ãƒ¢ãƒ‡ãƒ«å‡ºåŠ›: `{"predictions": {...}, "features": ...}`
- Lossé–¢æ•°æœŸå¾…: `{"horizon_1": ..., "horizon_5": ...}`

**ä¿®æ­£**:
`scripts/train_atft.py:3225-3234` ã§äºˆæ¸¬è¾æ›¸ã‚’æŠ½å‡ºã—ã¦ã‹ã‚‰ reshape

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **ä¿®æ­£å®Œäº†**

---

### å•é¡Œ3: ãƒŸãƒ‹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°OOMï¼ˆ11æœˆ3æ—¥ã«ä¿®æ­£æ¸ˆã¿ï¼‰

**ç—‡çŠ¶**:
```
CUDA out of memory. GPU 0 has a total capacity of 79.14 GiB
of which 768.00 KiB is free. Process has 79.13 GiB memory in use.
```

**åŸå› **:
åˆæœŸåŒ–å¾Œã«GPUã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚¯ãƒªã‚¢ã•ã‚Œãšã€ãƒŸãƒ‹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹å‰ã«79GBä½¿ç”¨

**ä¿®æ­£**:
`scripts/train_atft.py:6009-6014` ã§GPUã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚’è¿½åŠ 

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **ä¿®æ­£å®Œäº†**

---

## ğŸ“Š ä¿®æ­£å‰å¾Œã®æ¯”è¼ƒ

### ä¿®æ­£å‰ï¼ˆ2025-10-31ãƒ­ã‚°ï¼‰
```
âŒ Loss: 0.0005 (ç•°å¸¸ã«ä½ã„)
âŒ yhat_std: 0.000000 (å®šæ•°äºˆæ¸¬)
âŒ [ERROR] No matching horizons found
âŒ CUDA OOM in mini training
âŒ Targetåˆ—: èª­ã¿è¾¼ã‚ãš
```

### ä¿®æ­£å¾Œï¼ˆæœŸå¾…ã•ã‚Œã‚‹å‹•ä½œï¼‰
```
âœ… Loss: 0.2~0.5 (æ­£å¸¸ç¯„å›²ï¼‰
âœ… yhat_std: 0.005~0.020 (äºˆæ¸¬ã«åˆ†æ•£ï¼‰
âœ… Horizon matchingæ­£å¸¸å‹•ä½œ
âœ… Mini trainingèµ·å‹•å¯èƒ½
âœ… Targetåˆ—: æ­£å¸¸ãƒ­ãƒ¼ãƒ‰ï¼ˆmean/stdè¡¨ç¤ºï¼‰
```

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### å³åº§ã«å®Ÿè¡Œã™ã¹ãã“ã¨

1. **ãƒ•ãƒ«ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆï¼ˆ3ã‚¨ãƒãƒƒã‚¯ï¼‰**
```bash
make train-quick EPOCHS=3
```

**ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ**:
- âœ… `train/total_loss > 0.1` ï¼ˆã‚¼ãƒ­ã§ãªã„ï¼‰
- âœ… `yhat_std > 0.001` ï¼ˆäºˆæ¸¬ã«åˆ†æ•£ãŒã‚ã‚‹ï¼‰
- âœ… ã€ŒNo matching horizons foundã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„
- âœ… GPUä½¿ç”¨ç‡ > 50%

2. **ãƒ­ã‚°ã®ç¢ºèª**
```bash
tail -f _logs/training/train_*.log | grep -E "loss|yhat_std|SCALE"
```

3. **å•é¡ŒãŒç¶šãå ´åˆ**
```bash
# ã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰ã§è¨ºæ–­
FORCE_SINGLE_PROCESS=1 make train-safe EPOCHS=10
```

---

## ğŸ“ ä¿®æ­£å†…å®¹ã®è©³ç´°

### ä¿®æ­£1: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ—åä¿®æ­£
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `configs/atft/data/jpx_large_scale.yaml`
- **å¤‰æ›´**: `target_column: target` â†’ `target_column: feat_ret`
- **å¤‰æ›´**: `target_columns` ã®ãƒªã‚¹ãƒˆã‚’ `feat_ret_*d` ã«æ›´æ–°

### ä¿®æ­£2: äºˆæ¸¬è¾æ›¸æŠ½å‡ºï¼ˆ11æœˆ3æ—¥ï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/train_atft.py`
- **è¡Œ**: 3225-3234
- **å†…å®¹**: `outputs["predictions"]` ã‚’æŠ½å‡ºã—ã¦ã‹ã‚‰ reshape

### ä¿®æ­£3: GPUã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆ11æœˆ3æ—¥ï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/train_atft.py`
- **è¡Œ**: 6009-6014
- **å†…å®¹**: `torch.cuda.empty_cache()` + `gc.collect()`

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `AUTONOMOUS_CRITICAL_FIXES_20251103.md` - 11æœˆ3æ—¥ã®ä¿®æ­£è©³ç´°ï¼ˆè‹±èªï¼‰
- `TRAINING_RECOVERY_PLAN_JA.md` - å¾©æ—§ãƒ—ãƒ©ãƒ³ï¼ˆè©³ç´°æ‰‹é †ï¼‰

---

**ä½œæˆæ—¥**: 2025-11-03
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ä¿®æ­£å®Œäº†ã€ãƒ†ã‚¹ãƒˆå¾…ã¡
**å„ªå…ˆåº¦**: P0ï¼ˆæœ€é‡è¦ï¼‰
**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `make train-quick EPOCHS=3` ã‚’å®Ÿè¡Œ
