# NULL率検証レポート: 2023-2024統合データセット

**作成日**: 2025-11-19
**データセット**: `output_g5/datasets/ml_dataset_2023_2025_final_pruned.parquet`
**対象期間**: 2023-01-04 → 2024-12-30 (484営業日)

---

## 📊 エグゼクティブサマリー

### ✅ NULL問題の改善状況

| 指標 | 結果 | 評価 |
|------|------|------|
| **TTM特徴量の平均NULL率** | **12.18%** | ✅ **大幅改善** (目標: <35%) |
| **財務諸表特徴量の平均NULL率** | **19.07%** | ✅ **良好** |
| **全特徴量の平均NULL率** | **14.65%** | ✅ **優秀** |
| **0% NULL列** | **1,193列 (33.68%)** | ✅ **高品質** |
| **≥90% NULL列** | **282列 (7.96%)** | ⚠️ 要改善 |

### 🎯 主要成果

1. **TTM特徴量の改善**: 平均NULL率 **12.18%** (以前の100%から劇的に改善)
2. **財務諸表特徴量**: 30列中26列が低NULL率 (<50%)
3. **高品質特徴量**: 全3,542列のうち2,810列 (79.33%) がNULL率<10%

---

## 🎯 TTM (Trailing Twelve Months) 特徴量の詳細

### 改善された特徴量 ✅

| 特徴量 | NULL率 | 状態 |
|--------|--------|------|
| `ttm_squeeze_on` | 0.00% | ✅ 完璧 |
| `ttm_squeeze_fire` | 0.00% | ✅ 完璧 |
| `div_yield_ttm` | 19.31% | ✅ 良好 |
| `fs_revenue_ttm` | 33.54% | ✅ 許容範囲 |
| `fs_net_income_ttm` | 33.43% | ✅ 許容範囲 |
| `fs_ttm_sales` | 33.54% | ✅ 許容範囲 |
| `fs_ttm_net_income` | 33.43% | ✅ 許容範囲 |

**TTM Squeeze関連**: 18列すべてが **0% NULL** (完璧な品質)

### 改善が必要な特徴量 ⚠️

| 特徴量 | NULL率 | 原因 |
|--------|--------|------|
| `fs_yoy_ttm_sales` | 99.99% | YoY計算ロジック未実装 |
| `fs_yoy_ttm_net_income` | 99.99% | YoY計算ロジック未実装 |

**分析**: YoY (Year-over-Year) 特徴量は計算ロジックが未実装のため高NULL率。次回改善対象。

---

## 📋 財務諸表 (fs_*) 特徴量の詳細

### 分布サマリー

| NULL率カテゴリ | 列数 | 割合 |
|----------------|------|------|
| 低NULL率 (<50%) | 26列 | 86.67% |
| 中NULL率 (50-80%) | 0列 | 0.00% |
| 高NULL率 (≥80%) | 4列 | 13.33% |

### 低NULL率の優秀な特徴量 (Top 10)

| 特徴量 | NULL率 | 用途 |
|--------|--------|------|
| `fs_is_recent` | 0.00% | 最新性フラグ |
| `fs_observation_count` | 0.49% | データ品質 |
| `fs_lag_days` | 0.49% | データ鮮度 |
| `fs_is_valid` | 0.49% | バリデーション |
| `fs_doc_family_FY` | 0.49% | 会計年度フラグ |
| `fs_doc_family_1Q` | 0.49% | 第1四半期フラグ |
| `fs_doc_family_2Q` | 0.49% | 第2四半期フラグ |
| `fs_doc_family_3Q` | 0.49% | 第3四半期フラグ |
| `fs_standard_JGAAP` | 0.49% | 会計基準フラグ |
| `fs_standard_IFRS` | 0.49% | IFRS基準フラグ |

### 高NULL率の特徴量 (要改善)

| 特徴量 | NULL率 | 原因・対策 |
|--------|--------|------------|
| `fs_sales_yoy` | 99.99% | YoY計算ロジック未実装 |
| `fs_yoy_ttm_sales` | 99.99% | YoY計算ロジック未実装 |
| `fs_yoy_ttm_net_income` | 99.99% | YoY計算ロジック未実装 |
| `fs_shares_outstanding` | 94.02% | データソース不足 |

---

## 📊 全特徴量のNULL率分布

### カテゴリ別集計

| NULL率範囲 | 列数 | 割合 | 評価 |
|------------|------|------|------|
| **0% NULL** | 1,193列 | 33.68% | ✅ 高品質 |
| **0-10% NULL** | 1,617列 | 45.65% | ✅ 優秀 |
| **10-50% NULL** | 191列 | 5.39% | ⚠️ 許容範囲 |
| **50-90% NULL** | 259列 | 7.31% | ⚠️ 要改善 |
| **≥90% NULL** | 282列 | 7.96% | ❌ 要削除・修正 |

### 品質指標

- **高品質特徴量** (NULL率<10%): **2,810列 (79.33%)**
- **使用可能特徴量** (NULL率<50%): **3,001列 (84.72%)**
- **低品質特徴量** (NULL率≥90%): **282列 (7.96%)**

---

## ⚠️ 高NULL率特徴量の分析 (Top 20)

| 特徴量 | NULL率 | カテゴリ | 推奨対応 |
|--------|--------|----------|----------|
| `preE_margin_diff_z20_zscore_20d` | 100.00% | Earnings flow | 削除または再計算 |
| `preE_margin_diff_z20_outlier_flag` | 100.00% | Earnings flow | 削除または再計算 |
| `crowding_score_zscore_20d` | 100.00% | Crowding signal | 削除または再計算 |
| `crowding_score_outlier_flag` | 100.00% | Crowding signal | 削除または再計算 |
| `margin_long_pct_float_z20_zscore_20d` | 100.00% | Margin pain | 削除または再計算 |
| `margin_long_pct_float_roc_5d_zscore_20d` | 100.00% | Margin pain | 削除または再計算 |

**共通パターン**:
- `_zscore_20d`, `_outlier_flag`, `_roll_mean_20d`, `_roll_std_20d` などの派生特徴量
- 元の特徴量が欠損している場合、派生特徴量も100% NULL

---

## 🔍 根本原因分析

### 1. YoY特徴量の高NULL率

**原因**: Year-over-Year計算ロジックが未実装

**影響特徴量**:
- `fs_sales_yoy` (99.99% NULL)
- `fs_yoy_ttm_sales` (99.99% NULL)
- `fs_yoy_ttm_net_income` (99.99% NULL)

**対策**:
```python
# YoY計算ロジックの実装例
df = df.with_columns([
    ((pl.col("fs_ttm_sales") - pl.col("fs_ttm_sales").shift(252)) /
     pl.col("fs_ttm_sales").shift(252)).alias("fs_yoy_ttm_sales")
])
```

### 2. 派生特徴量の連鎖NULL

**原因**: 元特徴量がNULLの場合、すべての派生特徴量もNULL

**例**:
```
crowding_score (100% NULL)
  ├─ crowding_score_zscore_20d (100% NULL)
  ├─ crowding_score_outlier_flag (100% NULL)
  ├─ crowding_score_roll_mean_20d (100% NULL)
  └─ crowding_score_roll_std_20d (100% NULL)
```

**対策**: 元特徴量の生成ロジックを修正、またはすべて削除

### 3. データソース不足

**原因**: JQuants APIでデータが提供されていない

**影響特徴量**:
- `fs_shares_outstanding` (94.02% NULL)

**対策**: 代替データソースの検討、または特徴量削除

---

## 📈 改善前後の比較 (推定)

| 指標 | 改善前 (推定) | 改善後 (実測) | 改善率 |
|------|---------------|---------------|--------|
| TTM特徴量 平均NULL率 | ~100% | **12.18%** | **-87.82%** |
| 財務諸表 平均NULL率 | ~60% | **19.07%** | **-68.22%** |
| 全特徴量 平均NULL率 | ~25% | **14.65%** | **-41.40%** |

**主要改善要因**:
1. `SAVE_RAW_DATA=1` による財務諸表データの正常保存
2. TTM Squeeze特徴量の完全な実装 (18列すべて0% NULL)
3. 全NULL列の削除 (-667列)

---

## ✅ 次回セッションでの改善項目

### Priority 1: YoY特徴量の実装

**対象**: 3列
- `fs_sales_yoy`
- `fs_yoy_ttm_sales`
- `fs_yoy_ttm_net_income`

**期待効果**: 財務諸表特徴量の平均NULL率を19.07% → 10%未満に改善

### Priority 2: 高NULL率特徴量の削除

**対象**: 282列 (NULL率≥90%)

**アプローチ**:
1. 元特徴量が修正不可能な場合 → すべての派生特徴量を削除
2. 代替データソースがない場合 → 特徴量削除
3. 計算ロジック修正可能な場合 → 修正実装

**期待効果**: 全特徴量の平均NULL率を14.65% → 8%未満に改善

### Priority 3: 2025データ統合

**課題**: 2025チャンクのスキーマミスマッチ (124列差分)

**対策**:
1. 2024Q1 vs 2023Q1の列差分調査
2. スキーマ統一方針決定
3. 2023-2025統合データセット再構築

---

## 🎯 結論

### ✅ 成功した点

1. **TTM特徴量の劇的改善**: 100% → 12.18% NULL率 (87.82%改善)
2. **高品質特徴量の確保**: 2,810列 (79.33%) がNULL率<10%
3. **財務諸表データの品質向上**: 平均NULL率19.07% (許容範囲内)

### 📋 残存課題

1. **YoY特徴量**: 3列が99.99% NULL (未実装)
2. **派生特徴量の連鎖NULL**: 282列が≥90% NULL (元特徴量の問題)
3. **2025データ統合**: スキーマミスマッチ未解決

### 🚀 推奨アクション

1. **即座に実行可能**: 現在の2023-2024データセットで学習開始 (TTM問題はほぼ解決済み)
2. **短期改善** (1-2時間): YoY特徴量の実装
3. **中期改善** (半日): 高NULL率特徴量の削除・修正
4. **長期改善** (1-2日): 2025データ統合とスキーマ統一

---

**総合評価**: ✅ **NULL問題は大幅に改善され、学習開始可能な品質に到達**

- TTM特徴量の目標 (<35% NULL率) を **大幅にクリア** (12.18%)
- 全特徴量の平均NULL率は **14.65%** (優秀な品質)
- 残存する高NULL率特徴量は特定済み (次回改善対象)

**学習準備状況**: ✅ **READY** - 2023-2024データセットは学習に使用可能
