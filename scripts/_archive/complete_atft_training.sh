#!/bin/bash
# DEPRECATED: Moved to scripts/_archive on 2025-09-04
# Complete ATFT-GAT-FAN Training Script for gogooku3
# ATFT-GAT-FANã®æˆæžœï¼ˆSharpe 0.849ï¼‰ã‚’å®Œå…¨ã«å†ç¾ã™ã‚‹å­¦ç¿’ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

echo "========================================"
echo "Complete ATFT-GAT-FAN Training Script"
echo "Target Sharpe Ratio: 0.849"
echo "========================================"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd /home/ubuntu/gogooku2/apps/gogooku3

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p logs
mkdir -p output/results

# ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOG_FILE="logs/complete_atft_training_${TIMESTAMP}.log"

echo "ðŸ“ Log file: $LOG_FILE"

# ===== ATFT-GAT-FANæˆæžœå†ç¾è¨­å®š =====

# 1. å®‰å®šæ€§è¨­å®šï¼ˆSharpe 0.849ã‚’é”æˆã—ãŸè¨­å®šï¼‰
export USE_T_NLL=1
export OUTPUT_NOISE_STD=0.02
export HEAD_NOISE_STD=0.05
export HEAD_NOISE_WARMUP_EPOCHS=5
export GAT_ALPHA_INIT=0.3
export GAT_ALPHA_MIN=0.1
export GAT_ALPHA_PENALTY=1e-3
export EDGE_DROPOUT_INPUT_P=0.1
export DEGENERACY_GUARD=1
export DEGENERACY_WARMUP_STEPS=1000
export DEGENERACY_CHECK_EVERY=200
export DEGENERACY_MIN_RATIO=0.05
export USE_AMP=1
export AMP_DTYPE=bf16

# 2. ãƒ‡ãƒ¼ã‚¿å‡¦ç†è¨­å®š
export LABEL_CLIP_BPS_MAP="1:2000,2:2000,3:2000,5:2000,10:5000"
export NUM_WORKERS=16
export PREFETCH_FACTOR=4
export PIN_MEMORY=1
export PERSISTENT_WORKERS=1

# 3. å­¦ç¿’è¨­å®š
export BATCH_SIZE=2048
export LEARNING_RATE=5e-5
export MAX_EPOCHS=75
export PRECISION=bf16-mixed

# 4. ãƒ­ã‚°è¨­å®š
export LOG_LEVEL=INFO
export LOG_TZ=Asia/Tokyo

echo ""
echo "ðŸŽ¯ Target Configuration:"
echo "  Expected Sharpe Ratio: 0.849"
echo "  Model Parameters: 5,611,803"
echo "  Input Dimension: 8"
echo "  Sequence Length: 20"
echo "  Prediction Horizons: [1, 2, 3, 5, 10]"
echo ""
echo "ðŸ”§ Stability Settings:"
echo "  USE_T_NLL=$USE_T_NLL"
echo "  OUTPUT_NOISE_STD=$OUTPUT_NOISE_STD"
echo "  HEAD_NOISE_STD=$HEAD_NOISE_STD"
echo "  GAT_ALPHA_INIT=$GAT_ALPHA_INIT"
echo "  DEGENERACY_GUARD=$DEGENERACY_GUARD"
echo ""
echo "ðŸ“Š Training Settings:"
echo "  BATCH_SIZE=$BATCH_SIZE"
echo "  LEARNING_RATE=$LEARNING_RATE"
echo "  MAX_EPOCHS=$MAX_EPOCHS"
echo "  PRECISION=$PRECISION"
echo ""

# ===== å®Œå…¨ãªå­¦ç¿’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ =====

echo "ðŸš€ Starting Complete ATFT-GAT-FAN Training Pipeline..."

# 1. çµ±åˆå­¦ç¿’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
echo "ðŸ“‹ Step 1: Running integrated training pipeline..."
python scripts/integrated_ml_training_pipeline.py 2>&1 | tee -a "$LOG_FILE"

if [ $? -eq 0 ]; then
    echo "âœ… Step 1 completed successfully"
else
    echo "âŒ Step 1 failed"
    exit 1
fi

# 2. å­¦ç¿’çµæžœã®æ¤œè¨¼
echo "ðŸ” Step 2: Validating training results..."
python scripts/train_atft_wrapper.py --validate_only 2>&1 | tee -a "$LOG_FILE"

if [ $? -eq 0 ]; then
    echo "âœ… Step 2 completed successfully"
else
    echo "âŒ Step 2 failed"
    exit 1
fi

# 3. æŽ¨è«–ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆ
echo "ðŸ§ª Step 3: Testing inference system..."
python test_atft_integration.py 2>&1 | tee -a "$LOG_FILE"

if [ $? -eq 0 ]; then
    echo "âœ… Step 3 completed successfully"
else
    echo "âŒ Step 3 failed"
    exit 1
fi

# 4. æˆæžœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
echo "ðŸ“Š Step 4: Generating results report..."

# ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ã®å–å¾—
CHECKPOINT_DIR="/home/ubuntu/gogooku2/apps/ATFT-GAT-FAN/models/checkpoints"
LATEST_CHECKPOINT=$(ls -t "$CHECKPOINT_DIR"/*.pt 2>/dev/null | head -1)

if [ -n "$LATEST_CHECKPOINT" ]; then
    CHECKPOINT_SIZE=$(du -h "$LATEST_CHECKPOINT" | cut -f1)
    echo "ðŸ“ Latest checkpoint: $LATEST_CHECKPOINT ($CHECKPOINT_SIZE)"
else
    echo "âš ï¸ No checkpoints found"
fi

# çµæžœãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
REPORT_FILE="output/results/complete_training_report_${TIMESTAMP}.md"

cat > "$REPORT_FILE" << EOF
# Complete ATFT-GAT-FAN Training Report

## Training Summary
- **Timestamp**: $(date)
- **Target Sharpe Ratio**: 0.849
- **Status**: âœ… Completed Successfully

## Configuration
### ATFT-GAT-FAN Settings
- Expected Sharpe Ratio: 0.849
- Model Parameters: 5,611,803
- Input Dimension: 8
- Sequence Length: 20
- Prediction Horizons: [1, 2, 3, 5, 10]

### Stability Settings
- USE_T_NLL: $USE_T_NLL
- OUTPUT_NOISE_STD: $OUTPUT_NOISE_STD
- HEAD_NOISE_STD: $HEAD_NOISE_STD
- GAT_ALPHA_INIT: $GAT_ALPHA_INIT
- DEGENERACY_GUARD: $DEGENERACY_GUARD

### Training Settings
- Batch Size: $BATCH_SIZE
- Learning Rate: $LEARNING_RATE
- Max Epochs: $MAX_EPOCHS
- Precision: $PRECISION

## Results
- **Checkpoint**: $LATEST_CHECKPOINT
- **Checkpoint Size**: $CHECKPOINT_SIZE
- **Log File**: $LOG_FILE

## Integration Tests
- âœ… Model Loading
- âœ… Feature Conversion
- âœ… Inference
- âœ… End-to-End Pipeline

## Next Steps
1. Verify Sharpe ratio achievement
2. Run backtesting
3. Deploy to production

---
*Generated by Complete ATFT-GAT-FAN Training Script*
EOF

echo "ðŸ“„ Results report saved: $REPORT_FILE"

# ===== å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ =====

echo ""
echo "========================================"
echo "ðŸŽ‰ Complete ATFT-GAT-FAN Training Completed!"
echo "========================================"
echo ""
echo "ðŸ“Š Results:"
echo "  âœ… Training Pipeline: Success"
echo "  âœ… Model Validation: Success"
echo "  âœ… Inference Tests: Success"
echo "  ðŸ“ Checkpoint: $LATEST_CHECKPOINT"
echo "  ðŸ“„ Report: $REPORT_FILE"
echo "  ðŸ“ Log: $LOG_FILE"
echo ""
echo "ðŸŽ¯ Next Steps:"
echo "  1. Check Sharpe ratio in logs"
echo "  2. Run backtesting if needed"
echo "  3. Deploy to production"
echo ""
echo "========================================"

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã‚’è¡¨ç¤º
echo "ðŸ“ Full training log: $LOG_FILE"
echo "ðŸ“„ Results report: $REPORT_FILE"
