name: Repository Hygiene CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  hygiene-check:
    runs-on: ubuntu-latest
    name: Repository Hygiene Check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # For diff checks
        
    - name: Check for large files (>50MB)
      run: |
        echo "ğŸ” Checking for large files..."
        large_files=$(find . -size +50M -not -path "./.git/*" | head -10)
        if [ -n "$large_files" ]; then
          echo "âŒ ERROR: Large files detected (>50MB):"
          echo "$large_files"
          echo ""
          echo "ğŸ’¡ Please use Git LFS for large files:"
          echo "   git lfs track '*.pth' && git add .gitattributes"
          exit 1
        fi
        echo "âœ… No large files found"
        
    - name: Check for generated files in Git
      run: |
        echo "ğŸ” Checking for generated files..."
        generated_files=$(git ls-files | grep -E "\.(csv|parquet|pkl|joblib|png|jpg|pdf)$" | head -10)
        if [ -n "$generated_files" ]; then
          echo "âŒ WARNING: Generated files found in Git:"
          echo "$generated_files"
          echo ""
          echo "ğŸ’¡ These files should be in .gitignore or use Git LFS"
          # Warning only, don't fail
        else
          echo "âœ… No generated files in Git tracking"
        fi
        
    - name: Check for secrets
      run: |
        echo "ğŸ” Checking for potential secrets..."
        secret_patterns=(
          "password.*="
          "secret.*="
          "api_key.*="
          "private_key"
          "-----BEGIN.*PRIVATE KEY"
        )
        
        found_secrets=false
        for pattern in "${secret_patterns[@]}"; do
          matches=$(git ls-files -z | xargs -0 grep -l "$pattern" 2>/dev/null || true)
          if [ -n "$matches" ]; then
            echo "âŒ ERROR: Potential secrets found with pattern '$pattern':"
            echo "$matches"
            found_secrets=true
          fi
        done
        
        if [ "$found_secrets" = true ]; then
          echo ""
          echo "ğŸ’¡ Please remove secrets and use environment variables"
          exit 1
        fi
        echo "âœ… No secrets detected"
        
    - name: Check structure compliance
      run: |
        echo "ğŸ” Checking repository structure compliance..."
        
        # Check for logs outside _logs/
        scattered_logs=$(find . -path "./_logs" -prune -o -path "./.git" -prune -o \
          \( -name "*.log" -o -name "*.out" -o -name "*.err" \) -type f -print | head -5)
        
        if [ -n "$scattered_logs" ]; then
          echo "âŒ ERROR: Log files found outside _logs/ structure:"
          echo "$scattered_logs"
          echo ""
          echo "ğŸ’¡ Move to unified structure: _logs/{env}/{service}/{YYYY}/{MM}/{DD}/"
          exit 1
        fi
        
        # Check for Python files outside proper structure
        misplaced_py=$(find . -name "*.py" -not -path "./src/*" -not -path "./scripts/*" \
          -not -path "./tests/*" -not -path "./tools/*" -not -path "./.git/*" \
          -not -path "./_*" -not -path "./venv/*" | head -5)
          
        if [ -n "$misplaced_py" ]; then
          echo "âš ï¸ WARNING: Python files outside standard structure:"
          echo "$misplaced_py"
          echo ""
          echo "ğŸ’¡ Consider moving to src/ or scripts/"
          # Warning only
        fi
        
        echo "âœ… Structure compliance check complete"
        
    - name: Check for duplicate content
      run: |
        echo "ğŸ” Running basic duplicate detection..."
        
        # Check for exact filename duplicates
        duplicates=$(find . -type f -not -path "./.git/*" | \
          sed 's|.*/||' | sort | uniq -d | head -5)
          
        if [ -n "$duplicates" ]; then
          echo "âš ï¸ WARNING: Potential duplicate filenames found:"
          echo "$duplicates"
          echo ""
          echo "ğŸ’¡ Consider consolidating or renaming for clarity"
          # Warning only
        else
          echo "âœ… No obvious filename duplicates"
        fi
        
    - name: Validate critical files
      run: |
        echo "ğŸ” Validating critical files exist..."
        
        critical_files=(
          "pyproject.toml"
          "README.md"
          ".gitignore"
          "Makefile"
          "docker-compose.yml"
        )
        
        missing_files=()
        for file in "${critical_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          fi
        done
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "âŒ ERROR: Critical files missing:"
          printf '%s\n' "${missing_files[@]}"
          exit 1
        fi
        echo "âœ… All critical files present"

  summary:
    runs-on: ubuntu-latest
    name: Hygiene Summary
    needs: [hygiene-check]
    if: always()
    
    steps:
    - name: Report hygiene status
      run: |
        echo "ğŸ“‹ Gogooku3 Repository Hygiene Summary"
        echo "===================================="
        echo "âœ… Hygiene check: ${{ needs.hygiene-check.result }}"
        echo ""
        
        if [[ "${{ needs.hygiene-check.result }}" == "success" ]]; then
          echo "ğŸ‰ Repository hygiene is good!"
          echo "ğŸ“Š Clean and well-structured codebase maintained"
        else
          echo "âŒ Hygiene issues detected"
          echo "ğŸ’¡ Please review and fix the issues above"
        fi
        
        echo ""
        echo "ğŸ”§ For cleanup assistance:"
        echo "   python tools/repo_inventory.py"
        echo "   python tools/find_duplicates.py"
        echo "   python tools/classify_files.py"