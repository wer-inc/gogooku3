.PHONY: help dataset train-atft train-apex health-check status \
        build-2025 build-2020-2024 build-all \
        build-raw \
        validate validate-meta validate-quality validate-phase1 \
        clean-chunks list-chunks

help:
	@echo "gogooku5 migration helper targets"
	@echo ""
	@echo "Dataset Building:"
	@echo "  make build-2025         -> 2025å¹´å…¨å››åŠæœŸãƒ“ãƒ«ãƒ‰ (Q1-Q4)"
	@echo "  make build-2020-2024    -> 2020-2024å¹´å…¨æœŸé–“ãƒ“ãƒ«ãƒ‰"
	@echo "  make build-all          -> å…¨æœŸé–“ãƒ“ãƒ«ãƒ‰ (2020-2025)"
	@echo "  make build-raw          -> Rawã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å››åŠæœŸãƒãƒ£ãƒ³ã‚¯åŒ–ã— raw_manifest ã‚’å†ç”Ÿæˆ"
	@echo ""
	@echo "Validation:"
	@echo "  make validate           -> å…¨æ¤œè¨¼ (ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ + ãƒ‡ãƒ¼ã‚¿å“è³ª)"
	@echo "  make validate-meta      -> ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã®ã¿ (2025å¹´)"
	@echo "  make validate-quality   -> ãƒ‡ãƒ¼ã‚¿å“è³ªæ¤œè¨¼ã®ã¿ (2025å¹´)"
	@echo "  make validate-phase1    -> Phase 1æ©Ÿèƒ½æ¤œè¨¼ (å˜ä¸€ãƒãƒ£ãƒ³ã‚¯)"
	@echo ""
	@echo "Utilities:"
	@echo "  make list-chunks        -> ãƒãƒ£ãƒ³ã‚¯ä¸€è¦§è¡¨ç¤º"
	@echo "  make clean-chunks YEAR=2025  -> æŒ‡å®šå¹´ã®ãƒãƒ£ãƒ³ã‚¯å‰Šé™¤"
	@echo ""
	@echo "Legacy (Delegated):"
	@echo "  make dataset            -> delegate to data package"
	@echo "  make train-atft         -> delegate to ATFT-GAT-FAN package"
	@echo "  make train-apex         -> delegate to APEX-Ranker package"
	@echo "  make health-check       -> run shared health diagnostics"
	@echo "  make status             -> summarize dataset + model states"

_dataset_make := $(CURDIR)/data/Makefile
_models_atft := $(CURDIR)/models/atft_gat_fan/Makefile.train
_models_apex := $(CURDIR)/models/apex_ranker/Makefile.train
_tools_health := $(CURDIR)/tools/health-check.sh

ifeq (,$(wildcard $(_dataset_make)))
$(warning data package Makefile not found yet; add gogooku5/data/Makefile)
endif
ifeq (,$(wildcard $(_models_atft)))
$(warning ATFT-GAT-FAN Makefile.train not found yet; add gogooku5/models/atft_gat_fan/Makefile.train)
endif
ifeq (,$(wildcard $(_models_apex)))
$(warning APEX-Ranker Makefile.train not found yet; add gogooku5/models/apex_ranker/Makefile.train)
endif
ifeq (,$(wildcard $(_tools_health)))
$(warning health-check script not found yet; add gogooku5/tools/health-check.sh)
endif

# Common variables ---------------------------------------------------------

_output_dir := $(CURDIR)/../output_g5
_data_dir := $(CURDIR)/data
_tests_dir := $(CURDIR)/data/tests
_scripts_dir := $(CURDIR)/data/scripts
_dim_security := $(_output_dir)/dim_security.parquet
_raw_manifest := $(_output_dir)/raw_manifest.json

# Build configuration
export DATA_OUTPUT_DIR := $(_output_dir)
export DIM_SECURITY_PATH := $(_dim_security)
export RAW_MANIFEST_PATH := $(_raw_manifest)
export CATEGORICAL_COLUMNS := Code
export MAX_CONCURRENT_FETCH := 200
export MAX_PARALLEL_WORKERS := 128
export QUOTES_PARALLEL_WORKERS := 200

# Dataset Building targets -------------------------------------------------

build-2025:
	@echo "ğŸ”¨ Building 2025å¹´å…¨å››åŠæœŸ (Q1-Q4)..."
	@CURRENT_YEAR=$$(date +%Y); \
	CURRENT_MONTH=$$(date +%m); \
	if [ "$$CURRENT_YEAR" = "2025" ]; then \
		END_DATE=$$(date -d "$$(date +%Y-%m-01) +1 month -1 day" +%Y-%m-%d); \
	else \
		END_DATE="2025-12-31"; \
	fi; \
	echo "ğŸ“… Using end date: $$END_DATE (current: $$(date +%Y-%m-%d))"; \
	python3 $(_scripts_dir)/build_chunks.py \
		--start 2025-01-01 \
		--end $$END_DATE \
		--resume
	@echo "âœ… 2025å¹´ãƒ“ãƒ«ãƒ‰å®Œäº†"

build-2024:
	@echo "ğŸ”¨ Building 2024å¹´å…¨å››åŠæœŸ (Q1-Q4)..."
	@python3 $(_scripts_dir)/build_chunks.py \
		--start 2024-01-01 \
		--end 2024-12-31 \
		--resume
	@echo "âœ… 2024å¹´ãƒ“ãƒ«ãƒ‰å®Œäº†"

build-2020-2024:
	@echo "ğŸ”¨ Building 2020-2024å¹´å…¨æœŸé–“..."
	@python3 $(_scripts_dir)/build_chunks.py \
		--start 2020-01-01 \
		--end 2024-12-31 \
		--resume
	@echo "âœ… 2020-2024å¹´ãƒ“ãƒ«ãƒ‰å®Œäº†"

build-all:
	@echo "ğŸ”¨ Building å…¨æœŸé–“ (2020-2025)..."
	@python3 $(_scripts_dir)/build_chunks.py \
		--start 2020-01-01 \
		--end 2025-11-15 \
		--resume
	@echo "âœ… å…¨æœŸé–“ãƒ“ãƒ«ãƒ‰å®Œäº†"

# Raw snapshot chunking + manifest -----------------------------------------

build-raw:
	@echo "ğŸ”¨ Rawã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®å››åŠæœŸãƒãƒ£ãƒ³ã‚¯åŒ–ã¨ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆå†ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¾ã™..."
	@echo "   RAW_ROOT      = $(_output_dir)/raw"
	@echo "   RAW_MANIFEST  = $(_raw_manifest)"
	@python3 $(_data_dir)/tools/manage_raw_sources.py \
		chunk \
		--raw-root "$(_output_dir)/raw"
	@python3 $(_data_dir)/tools/manage_raw_sources.py \
		manifest \
		--raw-root "$(_output_dir)/raw" \
		--manifest "$(_raw_manifest)"
	@echo "âœ… Raw chunk + manifest æ›´æ–°å®Œäº† -> $(_raw_manifest)"

# Validation targets -------------------------------------------------------

validate: validate-meta validate-quality
	@echo ""
	@echo "âœ… å…¨æ¤œè¨¼å®Œäº† (ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ + ãƒ‡ãƒ¼ã‚¿å“è³ª)"

validate-meta:
	@echo "ğŸ“‹ 2025å¹´ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ä¸­..."
	@python3 $(_tests_dir)/validate_2025_complete.py

validate-quality:
	@echo "ğŸ” 2025å¹´ãƒ‡ãƒ¼ã‚¿å“è³ªæ¤œè¨¼ä¸­..."
	@python3 $(_tests_dir)/validate_2025_data_quality.py

validate-phase1:
	@echo "ğŸ”¬ Phase 1æ©Ÿèƒ½æ¤œè¨¼ä¸­ (2025Q4)..."
	@python3 $(_tests_dir)/validate_phase1_features.py

# Utility targets ----------------------------------------------------------

list-chunks:
	@echo "ğŸ“‚ ãƒãƒ£ãƒ³ã‚¯ä¸€è¦§:"
	@ls -lh $(_output_dir)/chunks/ 2>/dev/null || echo "ãƒãƒ£ãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

clean-chunks:
ifndef YEAR
	@echo "âŒ ã‚¨ãƒ©ãƒ¼: YEARå¤‰æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ (ä¾‹: make clean-chunks YEAR=2025)"
	@exit 1
endif
	@echo "ğŸ—‘ï¸  $(YEAR)å¹´ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å‰Šé™¤ä¸­..."
	@rm -rf $(_output_dir)/chunks/$(YEAR)Q*
	@echo "âœ… $(YEAR)å¹´ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"

# Delegated targets -------------------------------------------------------

dataset:
	@$(MAKE) -C data build

train-atft:
	@$(MAKE) -C models/atft_gat_fan train

train-apex:
	@$(MAKE) -C models/apex_ranker train

health-check:
	@$(MAKE) -C tools health-check

status:
	@$(MAKE) -C tools status
