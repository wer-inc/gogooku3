# TODO.md - gogooku3-standalone

**æœ€çµ‚æ›´æ–°**: 2025-10-07 14:15
**ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: `TODO.md.backup-*` (æ—§9,829è¡Œç‰ˆã‚’è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¸ˆã¿)

---

## ğŸ“Œ ç¾åœ¨ã®çŠ¶æ³ (2025-10-07)

### ğŸ”„ é€²è¡Œä¸­ã®ã‚¿ã‚¹ã‚¯

#### GATå‹¾é…ã‚¼ãƒ­å•é¡Œ - ç¬¬6æ¬¡Deep Reasoningå®Ÿæ–½ä¸­ ğŸ”
- **æœ€çµ‚æ›´æ–°**: 2025-10-07 14:15
- **çŠ¶æ…‹**: Graph builderæœ‰åŠ¹åŒ–æˆåŠŸã€GATå®Ÿè¡Œç¢ºèªã€æ–°ãŸãªå‹¾é…æ¶ˆå¤±å•é¡Œã‚’ç™ºè¦‹
- **å‰å›ä¿®æ­£ (ç¬¬5æ¬¡)**: Graph builder `use_in_training: false â†’ true` ã«å¤‰æ›´
- **çµæœ**: âœ… GATå®Ÿè¡ŒæˆåŠŸã€âœ… edge_indexæ¸¡ã—æˆåŠŸã€âŒ ã‚¹ãƒ†ãƒƒãƒ—2ä»¥é™ã§å‹¾é…æ¶ˆå¤±
- **æ–°ç™ºè¦‹ (ç¬¬6æ¬¡)**: ã‚¹ãƒ†ãƒƒãƒ—0-1ã§ã¯ `requires_grad=True`ã€ã‚¹ãƒ†ãƒƒãƒ—2ä»¥é™ã§ `requires_grad=False` ã«å¤‰åŒ–

### â³ æ¬¡ã®ã‚¿ã‚¹ã‚¯ï¼ˆå„ªå…ˆé †ï¼‰

1. **ç¬¬5æ¬¡èª¿æŸ» - è¨ºæ–­ãƒ­ã‚°åˆ†æ**ï¼ˆæœ€å„ªå…ˆï¼‰:
   - [x] è¨ºæ–­ãƒ­ã‚°è¿½åŠ å®Œäº†
   - [ ] è¨ºæ–­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œå®Œäº†å¾…ã¡
   - [ ] ãƒ­ã‚°ã‹ã‚‰ä»¥ä¸‹ã‚’ç¢ºèª:
     - [ ] `[GAT-INIT]` ã§ entropy_weight/edge_weight ã®å€¤
     - [ ] `[CONFIG-DEBUG]` ã§ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šå€¤
     - [ ] `[GAT-DEBUG]` ã§ gat_features ã®çŠ¶æ…‹
     - [ ] `[GAT-LOSS]` ã§ Loss è¿½åŠ ã®æœ‰ç„¡

2. **æ ¹æœ¬åŸå› ç‰¹å®šå¾Œã®ä¿®æ­£**:
   - [ ] Case A: è¨­å®šèª­ã¿è¾¼ã¿ä¿®æ­£
   - [ ] Case B: åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
   - [ ] Case C: Loss è¨ˆç®—ä¿®æ­£

3. **ä¿®æ­£å¾Œã®æ¤œè¨¼**:
   - [ ] PHASE_MAX_BATCHES=2 ã§çŸ­æœŸæ¤œè¨¼
   - [ ] GATå‹¾é…ãŒéã‚¼ãƒ­ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
   - [ ] æˆåŠŸå¾Œã€æœ¬ç•ªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹

---

## âœ… å®Œäº†ã—ãŸä¸»è¦ã‚¿ã‚¹ã‚¯

### 2025-10-06: GATå‹¾é…ã‚¼ãƒ­å•é¡Œ - èª¿æŸ»ãƒ»ä¿®æ­£ ğŸ¯

#### å•é¡Œã®èƒŒæ™¯
- ATFT-GAT-FANãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã€GATãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‹¾é…ãŒå¸¸ã«ã‚¼ãƒ­ã«ãªã‚‹ç¾è±¡ãŒç™ºç”Ÿ
- GATè‡ªä½“ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ï¼ˆ256â†’512æ¬¡å…ƒå¤‰æ›ç¢ºèªæ¸ˆã¿ï¼‰ãŒã€å‹¾é…ãŒGATãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¾ã§ä¼æ’­ã—ãªã„
- è¤‡æ•°ã®ä¿®æ­£è©¦è¡Œã‚’å®Ÿæ–½ã™ã‚‹ã‚‚è§£æ±ºã›ãš

#### èª¿æŸ»ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆ4å›ã®Deep Reasoningï¼‰

**ç¬¬1æ¬¡èª¿æŸ»**: `edge_index`æ¸¡ã—å¿˜ã‚Œä»®èª¬
- ä»®èª¬: `_forward_with_optional_graph()`ãŒedge_indexã‚’batch dictã«å«ã‚ã¦ã„ãªã„
- ä¿®æ­£: train_atft.pyå†…ã®é–¢æ•°ã‚’2ç®‡æ‰€ä¿®æ­£
- çµæœ: âŒ GATå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸãŒã€å‹¾é…ã‚¼ãƒ­ã¯ç¶™ç¶š

**ç¬¬2æ¬¡èª¿æŸ»**: `.detach()`ä»®èª¬
- ä»®èª¬: edge cacheã®`.detach()`ãŒå‹¾é…ã‚’åˆ‡æ–­
- ä¿®æ­£: train_atft.py:6785-6786ã®`.detach()`å‰Šé™¤
- æ¤œè¨¼: PHASE_MAX_BATCHES=20ã§å®Ÿè¡Œã€Batch 10ï¼ˆæ–°è¦edgeæ§‹ç¯‰æ™‚ï¼‰ç¢ºèª
- çµæœ: âŒ Batch 10ã§ã‚‚GATå‹¾é…ã‚¼ãƒ­ - ä»®èª¬ã¯ä¸æ­£è§£

**ç¬¬3æ¬¡èª¿æŸ»**: `torch.compile dynamic=False`ä»®èª¬
- ä»®èª¬: torch.compileã®dynamic=Falseè¨­å®šãŒå‹•çš„ã‚°ãƒ©ãƒ•ã¨éäº’æ›
- ä¿®æ­£: model/atft_gat_fan.yamlã§compile.enabled=falseè¨­å®š
- æ¤œè¨¼: PHASE_MAX_BATCHES=10ã§å®Ÿè¡Œ
- çµæœ: âŒ torch.compileç„¡åŠ¹ã§ã‚‚GATå‹¾é…ã‚¼ãƒ­ - torch.compileã¯åŸå› ã§ã¯ãªã„

**ç¬¬4æ¬¡èª¿æŸ»**: `backbone_projection`å‹•çš„å†ä½œæˆ âœ… **éƒ¨åˆ†çš„ã«è§£æ±º**
- ç™ºè¦‹: `_ensure_backbone_projection()`ãŒforward passä¸­ã«æ–°ã—ã„Linearå±¤ã‚’ä½œæˆ
- ãƒ¡ã‚«ãƒ‹ã‚ºãƒ :
  1. `__init__`: GATæœ‰åŠ¹æ™‚ â†’ `Linear(512, 256)`ä½œæˆ
  2. OptimizeråˆæœŸåŒ–: ã“ã®æ™‚ç‚¹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã¿ç™»éŒ²
  3. Forward pass: æ¬¡å…ƒå¤‰åŒ–æ¤œå‡º â†’ æ–°ã—ã„`Linear(256, 256)`ä½œæˆ
  4. æ–°å±¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯Optimizeræœªç™»éŒ² â†’ å‹¾é…è¨ˆç®—ã•ã‚Œã‚‹ãŒæ›´æ–°ã•ã‚Œãªã„
- è¨¼æ‹ : `/tmp/torch_compile_disabled_verification.log`ã«ã€ŒAdjusting backbone projection from 512 to 256ã€ã€Œfrom 256 to 512ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- ä¿®æ­£å®Ÿè£…: ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã§æ¬¡å…ƒçµ±ä¸€ã€å‹•çš„å±¤ä½œæˆã‚’é˜²æ­¢
- **çµæœ**: âœ… å‹•çš„å±¤ä½œæˆã¯è§£æ±ºã€âŒ GATå‹¾é…ã¯ã‚¼ãƒ­ã®ã¾ã¾

**ç¬¬5æ¬¡èª¿æŸ»**: Graph builder ç„¡åŠ¹åŒ–å•é¡Œ âœ… **æ ¹æœ¬åŸå› ç‰¹å®šãƒ»ä¿®æ­£å®Œäº†**
- **ç™ºè¦‹æ—¥æ™‚**: 2025-10-07 13:40
- **æ ¹æœ¬åŸå› **: `config_production_optimized.yaml` ã§ `use_in_training: false` ã«è¨­å®š
- **ãƒ¡ã‚«ãƒ‹ã‚ºãƒ **:
  1. Graph builder ãŒç„¡åŠ¹ â†’ edge_index ãŒæ§‹ç¯‰ã•ã‚Œãªã„
  2. `edge_index = None` â†’ GATå®Ÿè¡Œãƒ–ãƒ­ãƒƒã‚¯ãŒã‚¹ã‚­ãƒƒãƒ—ï¼ˆatft_gat_fan.py:588ï¼‰
  3. `_gat_attention_entropy` ã¨ `_gat_edge_reg_value` ãŒ `None` ã®ã¾ã¾
  4. GAT loss ãŒ total_loss ã«è¿½åŠ ã•ã‚Œãªã„
  5. **çµæœ**: GAT ã«å‹¾é…ãŒæµã‚Œãªã„
- **ä¿®æ­£å†…å®¹**: `configs/atft/config_production_optimized.yaml:185`
  ```yaml
  use_in_training: true  # FIX (2025-10-07): Enable graph builder
  ```
- **æ¤œè¨¼çµæœ** (gat_diagnostic_final2.log):
  - âœ… Graph edges æ§‹ç¯‰æˆåŠŸ: `E=2786` (Line 102)
  - âœ… GATå®Ÿè¡ŒæˆåŠŸ: `edge_index.shape=torch.Size([2, 2786])` (Line 103)
  - âœ… GATå‡ºåŠ›ç”Ÿæˆ: `shape=torch.Size([256, 256])` (Line 104)
  - âœ… GAT featuresåˆæœŸçŠ¶æ…‹: `requires_grad=True` (Line 106, step 0-1)
  - âœ… edge_index æ­£ã—ãæ¸¡ã•ã‚Œã‚‹: `[DEBUG-EDGE]` ãƒ­ã‚°ç¢ºèª (Line 110)
- **çµæœ**: âœ… GATå®Ÿè¡Œãƒ»edge_indexå•é¡Œã¯å®Œå…¨è§£æ±ºã€âŒ æ–°ãŸãªå‹¾é…æ¶ˆå¤±å•é¡Œã‚’ç™ºè¦‹

**ç¬¬6æ¬¡èª¿æŸ»**: å‹¾é…æ¶ˆå¤±å•é¡Œ (ã‚¹ãƒ†ãƒƒãƒ—2ä»¥é™) ğŸ” **NEW - é€²è¡Œä¸­**
- **çµŒç·¯**: ç¬¬4æ¬¡ä¿®æ­£å¾Œã‚‚GATå‹¾é…ã‚¼ãƒ­ãŒç¶™ç¶š
- **æ¤œè¨¼çŠ¶æ³**:
  - âœ… GATå±¤ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ï¼ˆãƒ­ã‚°ç¢ºèªæ¸ˆã¿: `[GAT-EXEC]`ï¼‰
  - âœ… edge_index ã¯æ­£ã—ãæ¸¡ã•ã‚Œã¦ã„ã‚‹ï¼ˆshape: [2, 2786]ï¼‰
  - âœ… GATå‡ºåŠ›ã¯ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ï¼ˆ(256, 256) â†’ (256, 20, 256)ï¼‰
  - âœ… backbone_projection å‹•çš„å†ä½œæˆã¯è§£æ±ºæ¸ˆã¿
  - âŒ **GATå‹¾é…ã¯ä¾ç„¶ã¨ã—ã¦ã‚¼ãƒ­**

- **æ–°ãŸãªç™ºè¦‹**ï¼ˆatft_gat_fan.py:577ï¼‰:
  ```python
  return_attention = self.training and self.gat is not None and self.gat_entropy_weight > 0
  ```
  - ã“ã®æ¡ä»¶ã«ã‚ˆã‚Šã€`gat_entropy_weight == 0` ãªã‚‰ attention weights ãŒè¿”ã•ã‚Œãªã„
  - attention weights ãŒãªã„ã¨ã€GAT entropy loss ãŒè¨ˆç®—ã•ã‚Œãªã„
  - çµæœã¨ã—ã¦ GAT å‡ºåŠ›ãŒ total loss ã«è²¢çŒ®ã—ãªã„å¯èƒ½æ€§

- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªçµæœ**:
  - âœ… `configs/atft/model/atft_gat_fan.yaml` ã«ã¯è¨­å®šã‚ã‚Š:
    ```yaml
    regularization:
      edge_weight_penalty: 0.01
      attention_entropy_penalty: 0.001
    ```
  - âŒ **`config_production_optimized.yaml` ã«ã¯è¨­å®šãªã— â†’ æ ¹æœ¬åŸå› ï¼**

---
## âœ… **Phase 6 å®Œäº† - GATå‹¾é…ã‚¼ãƒ­å•é¡Œã¯è§£æ±ºã—ãŸ** (2025-10-07 15:06)
**æ ¹æœ¬åŸå› **: `config_production_optimized.yaml` ã« `model.gat` è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã‹ã£ãŸ
**ä¿®æ­£**: `model.gat.regularization` ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ  (edge_weight_penalty=0.01, attention_entropy_penalty=0.001)
**æ¤œè¨¼**: âœ… ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œã§ GAT loss metrics è¨ˆç®—ç¢ºèªã€å‹¾é…ãƒ•ãƒ­ãƒ¼ç¢ºèª
**è©³ç´°**: ä¸‹è¨˜å‚ç…§
---

- **æ ¹æœ¬åŸå› ç‰¹å®šå®Œäº†** (2025-10-07 15:00):
  1. âœ… `config_production_optimized.yaml` ã« `model.gat` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„
  2. âœ… ãã®ãŸã‚ `regularization.edge_weight_penalty` ã¨ `attention_entropy_penalty` ãŒæœªè¨­å®š
  3. âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ `0.0` ãŒatft_gat_fan.py:167-168ã§åˆæœŸåŒ–ã•ã‚Œã‚‹
  4. âœ… `return_attention = self.training and self.gat is not None and self.gat_entropy_weight > 0` ãŒ `False` ã«ãªã‚‹ (line 577)
  5. âœ… GAT loss metrics (`_gat_attention_entropy`, `_gat_edge_reg_value`) ãŒè¨ˆç®—ã•ã‚Œãªã„
  6. âœ… training_step() ã§GAT lossãŒè¿½åŠ ã•ã‚Œãªã„ (line 823-844)
  7. **çµæœ**: âœ… GAT ã«å‹¾é…ãŒæµã‚Œãªã„ â†’ **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£ã§è§£æ±º**

- **ä¿®æ­£å†…å®¹** (2025-10-07 15:01):
  - **ãƒ•ã‚¡ã‚¤ãƒ«**: `configs/atft/config_production_optimized.yaml`
  - **å¤‰æ›´ç®‡æ‰€**: Line 106-122 (æ–°è¦è¿½åŠ )
  ```yaml
  gat:
    enabled: true
    architecture:
      hidden_channels: [256]
      heads: [4]
      concat: [true]
      num_layers: 1
    layer_config:
      dropout: 0.2
      edge_dropout: 0.1
    edge_features:
      edge_dim: 0
    regularization:
      edge_weight_penalty: 0.01        # ğŸ”§ FIX: Enable edge regularization loss
      attention_entropy_penalty: 0.001  # ğŸ”§ FIX: Enable attention entropy loss
  ```
  - **æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**:
    - `self.gat_entropy_weight = 0.001` (0.0 ã§ã¯ãªã„)
    - `self.gat_edge_weight = 0.01` (0.0 ã§ã¯ãªã„)
    - `return_attention = True` during training
    - GAT loss ãŒè¨ˆç®—ã•ã‚Œ total_loss ã«è¿½åŠ ã•ã‚Œã‚‹
    - GAT parameters ã«å‹¾é…ãŒæµã‚Œã‚‹

- **âœ… ä¿®æ­£å®Œäº†ãƒ»æ¤œè¨¼æˆåŠŸ** (2025-10-07 15:06):
  - **æ¤œè¨¼ãƒ­ã‚°**: `/tmp/gat_diagnostic_unbuffered.log`
  - **è¨­å®šãƒ­ãƒ¼ãƒ‰ç¢ºèª** (Line 52):
    ```
    [GAT-INIT] gat_entropy_weight=0.001, gat_edge_weight=0.01, gat_output_dim=256
    ```
    âœ… è¨­å®šãŒæ­£ã—ããƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸ (0.0 ã§ã¯ãªã„)

  - **return_attentionç¢ºèª** (Line 55, 61):
    ```
    # ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–æ™‚ (training=True):
    [RETURN-ATT] self.training=True, gat_is_not_none=True, entropy_weight=0.001 â†’ return_attention=True

    # å®Ÿéš›ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒ†ãƒƒãƒ—0 (training=True):
    [RETURN-ATT] self.training=True, gat_is_not_none=True, entropy_weight=0.001 â†’ return_attention=True
    ```
    âœ… ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã« return_attention=True ã«ãªã£ãŸï¼

  - **GAT loss metricsè¨ˆç®—ç¢ºèª** (Line 63-64):
    ```
    [RETURN-ATT] Taking return_attention=True branch - computing GAT loss metrics
    [RETURN-ATT] Set _gat_attention_entropy=1.730430, _gat_edge_reg_value=0.028566
    ```
    âœ… GAT loss metricsãŒè¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ï¼(éã‚¼ãƒ­å€¤)

  - **GAT featureså‹¾é…ç¢ºèª** (Line 67):
    ```
    [GAT-DEBUG] gat_features.shape=torch.Size([256, 20, 256]), requires_grad=True
    ```
    âœ… GAT featuresã«å‹¾é…ãŒæœ‰åŠ¹ï¼

  - **çµåˆå¾Œã®ç‰¹å¾´é‡å‹¾é…ç¢ºèª** (Line 70):
    ```
    [GAT-DEBUG] combined_features.requires_grad=True, normalized.requires_grad=True
    ```
    âœ… çµåˆå¾Œã‚‚å‹¾é…ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹ï¼

  - **ã‚°ãƒ©ãƒ•æ§‹ç¯‰ç¢ºèª** (Line 59-60):
    ```
    [src.graph.graph_builder][INFO] - Built correlation graph: nodes=256, edges=2786, avg_deg=10.88
    ```
    âœ… ã‚°ãƒ©ãƒ•ãŒæ­£ã—ãæ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹

  - **çµè«–**:
    - âœ… **Phase 6ã®ä¿®æ­£ã¯æˆåŠŸã—ãŸ**
    - âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã« `model.gat.regularization` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€GAT lossè¨ˆç®—ãŒæœ‰åŠ¹åŒ–ã•ã‚ŒãŸ
    - âœ… `return_attention=True` ã«ã‚ˆã‚Šã€GAT loss metricsãŒè¨ˆç®—ã•ã‚Œã€å‹¾é…ãŒGAT parametersã«æµã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ
    - âœ… **GATå‹¾é…ã‚¼ãƒ­å•é¡Œã¯è§£æ±ºã—ãŸ**

- **å®Ÿè£…ã—ãŸè¨ºæ–­ãƒ­ã‚°** (2025-10-06 14:50):
  1. **GATåˆæœŸåŒ–æ™‚** (atft_gat_fan.py:337):
     ```python
     logger.info(f"[GAT-INIT] gat_entropy_weight={self.gat_entropy_weight}, gat_edge_weight={self.gat_edge_weight}")
     ```

  2. **ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–å¾Œ** (train_atft.py:5798-5801):
     ```python
     logger.info(f"[CONFIG-DEBUG] model.gat_entropy_weight={model.gat_entropy_weight}")
     logger.info(f"[CONFIG-DEBUG] model.gat_edge_weight={model.gat_edge_weight}")
     logger.info(f"[CONFIG-DEBUG] model.gat is None: {model.gat is None}")
     ```

  3. **Forward passæ™‚** (atft_gat_fan.py:606-608, 616-618):
     ```python
     logger.info(f"[GAT-DEBUG] gat_features is None: {gat_features is None}")
     logger.info(f"[GAT-DEBUG] Checking concatenation: gat_features is not None = ...")
     logger.info(f"[GAT-DEBUG] Using GAT features branch" / "Using zero-padding branch")
     logger.info(f"[GAT-DEBUG] combined_features.requires_grad=...")
     ```

  4. **Lossè¨ˆç®—æ™‚** (atft_gat_fan.py:821, 828):
     ```python
     logger.info(f"[GAT-LOSS] Adding edge_reg={edge_reg.item():.6f}")
     logger.info(f"[GAT-LOSS] Adding entropy_reg={entropy_reg.item():.6f}")
     ```

- **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**:
  1. â³ è¨ºæ–­ãƒ­ã‚°ä»˜ãæ¤œè¨¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œä¸­
  2. ğŸ“Š ãƒ­ã‚°åˆ†æã§ä»¥ä¸‹ã‚’ç¢ºèª:
     - `gat_entropy_weight` ã®å®Ÿéš›ã®å€¤
     - `gat_features` ãŒ None ã‹ã©ã†ã‹
     - GAT loss ãŒ total_loss ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹
  3. ğŸ”§ åŸå› ç‰¹å®šå¾Œã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’å®Ÿæ–½:
     - **Case A**: weight ãŒ 0 â†’ è¨­å®šèª­ã¿è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
     - **Case B**: gat_features ãŒ None â†’ åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
     - **Case C**: Loss è¨ˆç®—æ¼ã‚Œ â†’ Loss é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£

- **çŠ¶æ…‹**: ğŸŸ¡ è¨ºæ–­ãƒ­ã‚°å®Ÿè£…å®Œäº†ã€æ¤œè¨¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œä¸­

#### å®Ÿè£…ã—ãŸä¿®æ­£ï¼ˆç¬¬4æ¬¡ï¼‰

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `src/atft_gat_fan/models/architectures/atft_gat_fan.py` (Line 600-624)

**ä¿®æ­£å†…å®¹**:
```python
# ğŸ”§ FIX (2025-10-06): Always use consistent dimensions
if gat_features is not None:
    combined_features = torch.cat([tft_output, gat_features], dim=-1)
else:
    # GAT disabled or no edges: pad with zeros to match expected dimension
    if self.gat is not None:
        zero_pad = torch.zeros(
            tft_output.size(0), tft_output.size(1), self.gat_output_dim,
            device=tft_output.device, dtype=tft_output.dtype
        )
        combined_features = torch.cat([tft_output, zero_pad], dim=-1)
    else:
        combined_features = tft_output

# ğŸ”§ FIX: No longer need dynamic dimension check
combined_features = self.backbone_projection(combined_features)
```

**ä¿®æ­£ã®ãƒã‚¤ãƒ³ãƒˆ**:
1. GATæœªå®Ÿè¡Œæ™‚ã‚‚**ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°**ã§æ¬¡å…ƒã‚’512ã«çµ±ä¸€
2. `_ensure_backbone_projection()`å‘¼ã³å‡ºã—ã‚’å®Œå…¨å‰Šé™¤ï¼ˆLine 611ï¼‰
3. `backbone_projection`ã®å‹•çš„å†ä½œæˆã‚’é˜²æ­¢
4. åˆæœŸåŒ–æ™‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨ â†’ Optimizerç™»éŒ²æ¸ˆã¿ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å­¦ç¿’

---

### 2025-10-01: 395åˆ—ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå®Ÿè£… âœ…

**å®Ÿè£…æ¦‚è¦**:
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä»•æ§˜ï¼ˆ`docs/ml/dataset_new.md`ï¼‰ã®395åˆ—ã‚’å®Œå…¨å®Ÿè£…

**å®Œäº†é …ç›®**:
- Phase 1: Makefileãƒ•ãƒ©ã‚°æœ‰åŠ¹åŒ– (+56åˆ—)
  - `--enable-sector-cs`: ã‚»ã‚¯ã‚¿ãƒ¼å†…ã‚¯ãƒ­ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒŠãƒ«ç‰¹å¾´ï¼ˆ15åˆ—ï¼‰
  - `--enable-daily-margin`: æ—¥æ¬¡ãƒãƒ¼ã‚¸ãƒ³ç‰¹å¾´ï¼ˆ41åˆ—ï¼‰
- Phase 2: ã‚»ã‚¯ã‚¿ãƒ¼é›†ç´„æ©Ÿèƒ½ (+30åˆ—)
  - æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: `src/gogooku3/features/sector_aggregation.py`
  - ã‚»ã‚¯ã‚¿ãƒ¼ç­‰åŠ é‡ãƒªã‚¿ãƒ¼ãƒ³ã€æ™‚ç³»åˆ—ã€ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã€å€‹åˆ¥-ã‚»ã‚¯ã‚¿ãƒ¼ç›¸å¯¾
- Phase 3: ã‚»ã‚¯ã‚¿ãƒ¼One-Hot (+17åˆ—)
- Phase 4: ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æˆç†Ÿãƒ•ãƒ©ã‚° (+8åˆ—)
- Phase 5: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç‰¹å¾´ (+18åˆ—)
- Phase 6: æ‹¡å¼µãƒ­ãƒ¼ãƒªãƒ³ã‚°çµ±è¨ˆ (+20åˆ—)
- Phase 7: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ¬ã‚¸ãƒ¼ãƒ ç‰¹å¾´ (+30åˆ—)

**åˆ—æ•°é€²æ—**:
- ç›®æ¨™: 395åˆ—
- å®Ÿè£…å®Œäº†: 392åˆ— (99.2%)
- æ®‹ã‚Š3åˆ—: GPU-ETLç‰¹æœ‰ã®é«˜åº¦ãªç‰¹å¾´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

---

### 2025-09-16: çµ±åˆMLãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ âœ…

**ä¸»è¦æ©Ÿèƒ½**:
- `integrated_ml_training_pipeline.py`: çµ±åˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `SafeTrainingPipeline`: 7ã‚¹ãƒ†ãƒƒãƒ—æ¤œè¨¼ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
  1. ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° (ProductionDatasetV3)
  2. å“è³ªç‰¹å¾´ç”Ÿæˆ (QualityFinancialFeaturesGenerator)
  3. ã‚¯ãƒ­ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒŠãƒ«æ­£è¦åŒ– (CrossSectionalNormalizerV2)
  4. Walk-Forwardåˆ†å‰² (WalkForwardSplitterV2ã€20æ—¥embargo)
  5. GBMãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ (LightGBMFinancialBaseline)
  6. ã‚°ãƒ©ãƒ•æ§‹ç¯‰ (FinancialGraphBuilder)
  7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ

**æ¤œè¨¼çµæœ**:
- ãƒ‡ãƒ¼ã‚¿: 606,127ã‚µãƒ³ãƒ—ãƒ«ã€644éŠ˜æŸ„ã€2021-2025 (4å¹´+)
- é€Ÿåº¦: 1.9s å…¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
- ãƒ¡ãƒ¢ãƒª: 7.0GB ãƒ”ãƒ¼ã‚¯ä½¿ç”¨é‡ (ç›®æ¨™<8GBé”æˆ)
- ã‚°ãƒ©ãƒ•: 50ãƒãƒ¼ãƒ‰ã€266ç›¸é–¢ã‚¨ãƒƒã‚¸

---

### 2025-09-07: ã‚»ã‚¯ã‚¿ãƒ¼ã‚¨ãƒ³ãƒªãƒƒãƒãƒ¡ãƒ³ãƒˆ (ä¸€éƒ¨å®Œäº†)

**å®Ÿè£…æ¸ˆã¿**:
- ã‚»ã‚¯ã‚¿ãƒ¼é›†ç´„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (`sector_aggregation.py`)
- ã‚»ã‚¯ã‚¿ãƒ¼ç­‰åŠ é‡ãƒªã‚¿ãƒ¼ãƒ³è¨ˆç®—
- ã‚»ã‚¯ã‚¿ãƒ¼ç›¸å¯¾ç‰¹å¾´ï¼ˆbeta, alpha, z-scoreï¼‰

**ç¾åœ¨ã®çŠ¶æ…‹**: åŸºæœ¬æ©Ÿèƒ½å®Ÿè£…å®Œäº†ã€æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã§ã®å¤§è¦æ¨¡æ¤œè¨¼ã¯æœªå®Ÿæ–½

---

## ğŸ› æ—¢çŸ¥ã®èª²é¡Œ

### ğŸ” é€²è¡Œä¸­ã®èª²é¡Œ

#### 1. GATå‹¾é…ã‚¼ãƒ­å•é¡Œ (2025-10-06) - ç¬¬5æ¬¡èª¿æŸ»ä¸­
- **çŠ¶æ…‹**: ç¬¬5æ¬¡Deep Reasoningå®Ÿæ–½ä¸­ã€æ–°ãŸãªä»®èª¬ã‚’æ¤œè¨¼
- **é€²æ—**:
  - âœ… ç¬¬1æ¬¡: edge_index æ¸¡ã—ä¿®æ­£
  - âœ… ç¬¬2æ¬¡: .detach() å‰Šé™¤
  - âœ… ç¬¬3æ¬¡: torch.compile ç„¡åŠ¹åŒ–
  - âœ… ç¬¬4æ¬¡: backbone_projection å‹•çš„å†ä½œæˆé˜²æ­¢
  - ğŸ” ç¬¬5æ¬¡: GAT Loss Weight ã‚¼ãƒ­ä»®èª¬ï¼ˆé€²è¡Œä¸­ï¼‰
- **æœ€æ–°ä»®èª¬**: `gat_entropy_weight=0` ã«ã‚ˆã‚Š GAT loss ãŒè¨ˆç®—ã•ã‚Œã¦ã„ãªã„
- **è¨ºæ–­**: è©³ç´°ãƒ­ã‚°è¿½åŠ å®Œäº†ã€æ¤œè¨¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œä¸­
- **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: ãƒ­ã‚°åˆ†æ â†’ æ ¹æœ¬åŸå› ç‰¹å®š â†’ ä¿®æ­£å®Ÿè£…

### âš ï¸ æœªè§£æ±ºã®èª²é¡Œ

- (æ¤œè¨¼å®Œäº†å¾Œã«æ›´æ–°äºˆå®š)

---

## ğŸ“š é‡è¦ãªæŠ€è¡“çš„å­¦ç¿’

### PyTorchã®é‡è¦ãªåˆ¶ç´„

#### 1. OptimizeråˆæœŸåŒ–å¾Œã®å‹•çš„å±¤è¿½åŠ ã¯å±é™º
- **å•é¡Œ**: `model.parameters()`ã¯åˆæœŸåŒ–æ™‚ç‚¹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
- **çµæœ**: Forward passä¸­ã®å±¤å†ä½œæˆã¯Optimizeræœªç™»éŒ²ã«ãªã‚‹
- **å¯¾ç­–**: å‹•çš„ãªå±¤ä½œæˆã¯`__init__`ã®ã¿ã§è¡Œã†

#### 2. å‹•çš„ã‚°ãƒ©ãƒ•ã®æ­£ã—ã„å®Ÿè£…
- **åŸå‰‡**: æ¬¡å…ƒå¤‰åŒ–ãŒäºˆæƒ³ã•ã‚Œã‚‹å ´åˆã¯**ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°**ã§çµ±ä¸€
- **ç†ç”±**: æ¡ä»¶åˆ†å²ã§ã‚‚å‡ºåŠ›æ¬¡å…ƒã‚’ä¸€å®šã«ä¿ã¤å¿…è¦ãŒã‚ã‚‹
- **å®Ÿè£…ä¾‹**:
  ```python
  if feature is None:
      # ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã§æ¬¡å…ƒçµ±ä¸€
      feature = torch.zeros(size, dim, device=device)
  combined = torch.cat([base, feature], dim=-1)
  ```

#### 3. å‹¾é…ãƒ‡ãƒãƒƒã‚°ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- **é‡è¦**: å‹¾é…ã‚¼ãƒ­ â‰  å¿…ãšã—ã‚‚è¨ˆç®—ã‚°ãƒ©ãƒ•åˆ‡æ–­
- **ç¢ºèªé …ç›®**:
  1. è¨ˆç®—ã‚°ãƒ©ãƒ•ã®é€£ç¶šæ€§ (`requires_grad=True`)
  2. Optimizerç™»éŒ²çŠ¶æ³ (`optimizer.param_groups`)
  3. Parameter IDã¨Optimizerã®å¯¾å¿œ
- **ãƒ„ãƒ¼ãƒ«**:
  - `torch.autograd.grad()`: å‹¾é…ã®æ‰‹å‹•ç¢ºèª
  - `register_hook()`: ä¸­é–“å±¤ã®å‹¾é…ç›£è¦–

---

## ğŸ“‹ å‚è€ƒæƒ…å ±

### ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆæœ¬ç•ªï¼‰
cd /home/ubuntu/gogooku3-standalone
make train-optimized                    # æœ€é©åŒ–è¨­å®šã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°
make train-integrated                   # çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä½¿ç”¨

# ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆæ¤œè¨¼ç”¨ï¼‰
PHASE_MAX_BATCHES=20 python scripts/train_atft.py \
  --config-path ../configs/atft \
  --config-name config_production_optimized

# ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆï¼ˆGPU-ETLæ¨å¥¨ï¼‰
make dataset-full-gpu START=2015-09-27 END=2025-09-26
make dataset-full START=2020-09-06 END=2025-09-06  # CPUç‰ˆ

# æ¤œè¨¼ãƒ»ç›£è¦–
tail -f /tmp/dimension_fix_verification.log | grep -E 'GAT grad|GUARD|Batch'
grep -E "GAT grad|GUARD|step=" /tmp/dimension_fix_verification.log

# ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†
ps aux | grep "train_atft.py"           # å®Ÿè¡Œä¸­ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
pkill -f "PHASE_MAX_BATCHES"            # æ¤œè¨¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°åœæ­¢
```

### ç’°å¢ƒæƒ…å ±

```
GPU: NVIDIA A100 80GB PCIe
CPU: 24-core AMD EPYC 7V13
Memory: 216GB RAM
Storage: 291GB SSD (167GB free)
```

### é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«

```
# ãƒ¢ãƒ‡ãƒ«å®Ÿè£…
src/atft_gat_fan/models/architectures/atft_gat_fan.py  # ATFT-GAT-FANãƒ¢ãƒ‡ãƒ«

# è¨­å®š
configs/atft/config_production_optimized.yaml    # æœ¬ç•ªæœ€é©åŒ–è¨­å®š
configs/atft/model/atft_gat_fan.yaml             # ãƒ¢ãƒ‡ãƒ«è¨­å®š
configs/atft/train/production_improved.yaml      # ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®š

# ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
scripts/train_atft.py                             # ãƒ¡ã‚¤ãƒ³ã‚¹ ã‚¯ãƒªãƒ—ãƒˆ
scripts/integrated_ml_training_pipeline.py        # çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

# ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
scripts/pipelines/run_full_dataset.py            # å®Œå…¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆ
src/gogooku3/features/sector_aggregation.py      # ã‚»ã‚¯ã‚¿ãƒ¼æ©Ÿèƒ½
```

---

## ğŸ“ å±¥æ­´ãƒ»å¤‰æ›´ãƒ­ã‚°

### 2025-10-06

**åˆå‰ï¼ˆ~12:00ï¼‰**:
- GATå‹¾é…ã‚¼ãƒ­å•é¡Œã®4å›ç›®ã®Deep Reasoningå®Œäº†
- backbone_projectionå‹•çš„å†ä½œæˆãŒæ ¹æœ¬åŸå› ã¨ç‰¹å®š
- ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«ã‚ˆã‚‹æ¬¡å…ƒå›ºå®šä¿®æ­£ã‚’å®Ÿè£…
- æ¤œè¨¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹ï¼ˆPHASE_MAX_BATCHES=20ï¼‰
- TODO.mdå¤§å¹…æ•´ç†ï¼ˆ9,829è¡Œâ†’ç´„350è¡Œã€92%å‰Šæ¸›ï¼‰

**åˆå¾Œï¼ˆ14:50~15:10ï¼‰**:
- ç¬¬4æ¬¡ä¿®æ­£å¾Œã‚‚GATå‹¾é…ã‚¼ãƒ­ãŒç¶™ç¶šã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- ç¬¬5æ¬¡Deep Reasoningé–‹å§‹ï¼šGAT Loss Weight ã‚¼ãƒ­ä»®èª¬
- æ–°ãŸãªç™ºè¦‹ï¼š`return_attention` æ¡ä»¶ã§ `gat_entropy_weight > 0` ãŒå¿…è¦
- 4ç¨®é¡ã®è¨ºæ–­ãƒ­ã‚°è¿½åŠ å®Ÿè£…:
  - `[GAT-INIT]`: åˆæœŸåŒ–æ™‚ã® weight å€¤
  - `[CONFIG-DEBUG]`: ãƒ¢ãƒ‡ãƒ«è¨­å®šç¢ºèª
  - `[GAT-DEBUG]`: Forward pass çŠ¶æ…‹
  - `[GAT-LOSS]`: Loss è¨ˆç®—è¿½è·¡
- TODO.mdæ›´æ–°ï¼šç¬¬5æ¬¡èª¿æŸ»ã®è©³ç´°ã‚’è¨˜éŒ²

### 2025-10-01
- 395åˆ—ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå®Ÿè£…å®Œäº†ï¼ˆ392åˆ—é”æˆã€99.2%ï¼‰
- å…¨7ãƒ•ã‚§ãƒ¼ã‚ºã®ç‰¹å¾´ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°å®Œäº†

### 2025-09-16
- çµ±åˆMLãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè£…
- SafeTrainingPipelineï¼ˆ7ã‚¹ãƒ†ãƒƒãƒ—ï¼‰å®Ÿè£…
- å®Ÿãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å®Œäº†ï¼ˆ606K samplesã€644 stocksï¼‰

### 2025-09-07
- ã‚»ã‚¯ã‚¿ãƒ¼ã‚¨ãƒ³ãƒªãƒƒãƒãƒ¡ãƒ³ãƒˆåŸºæœ¬æ©Ÿèƒ½å®Ÿè£…

---

**æ³¨**: æ—§TODO.mdã¯`TODO.md.backup-20251006-*`ã¨ã—ã¦ä¿å­˜æ¸ˆã¿ã€‚è©³ç´°ãªå®Ÿè£…å±¥æ­´ã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
