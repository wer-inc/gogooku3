# Production-optimized configuration based on PDF analysis
# PDFの提案と現状分析に基づく最適化設定

defaults:
  - _self_
  - data: jpx_large_scale
  - model: atft_gat_fan  # 256 hidden_size version
  - train: production_improved
  - hardware: default
  - override hydra/hydra_logging: default
  - override hydra/job_logging: default

# Hydra configuration
hydra:
  job:
    chdir: false
    name: ATFT-GAT-FAN-Optimized
  run:
    dir: logs/${now:%Y-%m-%d}/${now:%H-%M-%S}
  sweep:
    dir: logs/multirun/${now:%Y-%m-%d}/${now:%H-%M-%S}
    subdir: ${hydra.job.num}

# ============================================================================
# Improvements based on PDF recommendations
# ============================================================================

improvements:
  # torch.compile re-enabled for A100 optimization (2025-10-28)
  # Safe selective compilation: TFT + Head only, excludes GAT (dynamic graph)
  compile_model: true  # RE-ENABLED: +10-30% GPU throughput on A100
  compile_mode: "reduce-overhead"  # FIX: max-autotune causes CUDA misaligned address errors
  compile_fullgraph: false
  compile_dynamic: false

  # データローダー並列化 (PDF要件 + optimized for A100)
  force_multiworker: true  # Override safety guard
  num_workers: 8
  persistent_workers: true
  prefetch_factor: 8  # Increased from 4 for A100 throughput (2025-10-28)

  # 目的関数の重み最適化 (PDF指摘: 現在Sharpe/ICが横ばい)
  loss_weights:
    use_rankic: true
    rankic_weight: 0.2  # Increased from default
    cs_ic_weight: 0.15  # Increased from 0.05
    sharpe_weight: 0.3  # Focus on Sharpe

  # フェーズ別ロス重み (段階的に金融メトリクス重視へ)
  phase_loss_weights:
    phase_0: "huber=0.3,quantile=1.0,sharpe=0.0"
    phase_1: "quantile=0.5,sharpe=0.4,rankic=0.1"
    phase_2: "quantile=0.4,sharpe=0.6,rankic=0.2,t_nll=0.2"
    phase_3: "quantile=0.3,sharpe=0.8,rankic=0.3,cs_ic=0.2"

# ============================================================================
# Feature grouping alignment (Corrected: 192 actual features)
# ============================================================================

# Path to feature category mapping file (actual dataset features)
feature_categories_config: configs/atft/feature_categories_actual.yaml

# ============================================================================
# Model configuration (aligned with feature groups)
# ============================================================================

model:
  name: ATFT_GAT_FAN
  hidden_size: 256  # Increased from 64

  # Input dimensions aligned with curated core50/plus30 bundles (83 columns incl. masks)
  input_dims:
    total_features: 83      # Updated 2025-10-27: curated feature bundles
    historical_features: 0  # No historical features for now

    # Feature group breakdown (NOT USED - category split disabled)
    # Counts retained for documentation only; aggregation handled dynamically
    basic_features: 83
    technical_features: 0
    ma_derived_features: 0
    returns_features: 0
    market_features: 0
    flows_features: 0
    statements_features: 0
    additional_features: 0

  # Variable Selection Networks (VSN) per feature group
  # RE-ENABLED after prediction collapse diagnosis completed (2025-10-04)
  variable_selection:
    enabled: true  # Re-enabled for better feature selection
    per_feature_group: false

  # Frequency Adaptive Normalization (FAN) settings
  # RE-ENABLED after prediction collapse diagnosis completed (2025-10-04)
  fan:
    enabled: true  # Re-enabled for adaptive temporal normalization

  # Slice Adaptive Normalization (SAN) settings
  # RE-ENABLED after prediction collapse diagnosis completed (2025-10-04)
  san:
    enabled: true  # Re-enabled for cross-sectional learning

  # 🔧 GAT configuration (2025-10-07)
  # CRITICAL FIX: Add regularization weights to enable GAT loss calculation
  gat:
    enabled: true
    architecture:
      hidden_channels: [256]  # Match model hidden_size
      heads: [4]
      concat: [true]
      num_layers: 1
    layer_config:
      dropout: 0.2
      edge_dropout: 0.1
    edge_features:
      edge_dim: 3  # No edge features
    regularization:
      edge_weight_penalty: 0.01        # 🔧 FIX: Enable edge regularization loss
      attention_entropy_penalty: 0.001  # 🔧 FIX: Enable attention entropy loss

  # 🔧 CRITICAL FIX: torch.compile無効化 (2025-10-06)
  # GAT勾配ゼロ問題の根本原因: dynamic=False設定が動的グラフと非互換
  optimization:
    compile:
      enabled: false  # DISABLED to fix GAT gradient zero issue
      mode: "reduce-overhead"
      dynamic: false
      fullgraph: false

# ============================================================================
# Training configuration
# ============================================================================

train:
  trainer:
    max_epochs: 120  # Extended for better convergence
    precision: bf16-mixed
    gradient_clip_val: 1.0

  optimizer:
    lr: 5e-4  # Slightly higher for larger model
    weight_decay: 1e-5

  scheduler:
    name: plateau  # Better than cosine for this problem
    monitor: val/rank_ic_5d
    patience: 7
    factor: 0.5
    min_lr: 1e-6

  batch:
    batch_size: 2048
    accumulate_grad_batches: 2  # Effective batch = 4096

  early_stopping:
    monitor: val/rank_ic_5d  # Focus on RankIC
    mode: max
    patience: 20
    min_delta: 1e-4

# ============================================================================
# Normalization configuration (CRITICAL FIX 2025-10-03)
# ============================================================================

normalization:
  # Cross-sectional Z-scores are generated during conversion; skip online normalization
  online_normalization:
    enabled: false

  cross_sectional:
    enabled: false

# ============================================================================
# Data configuration
# ============================================================================

data:
  path: ${oc.env:OUTPUT_BASE}/ml_dataset_full.parquet

  # Schema configuration (required)
  schema:
    date_column: date
    code_column: code
    target_column: target

  # Graph builder configuration (required)
  # Updated 2025-10-04 based on TODO recommendations for improved RankIC
  graph_builder:
    cache_dir: graph_cache
    ewm_halflife: 30
    k: 24  # Increased from 20 (TODO recommendation)
    edge_threshold: 0.18  # Reduced from 0.20 for denser graph (TODO recommendation)
    min_edges: 75  # Increased from 50 (TODO recommendation)
    log_mktcap_col: log_mktcap
    lookback: 60
    method: ewm_demean
    min_obs: 40
    use_in_training: true  # FIX (2025-10-07): Enable graph builder to fix GAT gradient zero problem
    return_cols:
    - return_1d
    - feat_ret_1d
    returns_channel_index: 0
    sector_col: sector33
    shrinkage_gamma: 0.1
    size_tau: 1.0
    source_glob: ${data.source.data_dir}/train/*.parquet
    symmetric: true

  # Walk-forward validation
  split:
    method: walk_forward
    n_splits: 5
    embargo_days: 10
    min_train_days: 252

  # Feature selection
  selected_features_json: null  # Will use auto-detection with category mapping

  # Time series settings
  time_series:
    sequence_length: 60
    prediction_horizons: [1, 5, 10, 20]

# ============================================================================
# Environment overrides (will be set automatically)
# ============================================================================

environment:
  # These will be set by the execution script
  allow_unsafe_dataloader: ${oc.env:ALLOW_UNSAFE_DATALOADER,1}
  use_rankic: ${oc.env:USE_RANKIC,1}
  cs_ic_weight: ${oc.env:CS_IC_WEIGHT,0.15}
  sharpe_weight: ${oc.env:SHARPE_WEIGHT,0.3}
  phase_loss_weights: ${oc.env:PHASE_LOSS_WEIGHTS,}

# ============================================================================
# Monitoring and logging
# ============================================================================

logging:
  level: INFO
  wandb:
    enabled: false  # Enable if using W&B
    project: atft-gat-fan-optimized
  tensorboard:
    enabled: true
    log_dir: logs/optimized

# ============================================================================
# Experimental features (future work)
# ============================================================================

experimental:
  ddp:
    enabled: false  # Future: Enable for multi-GPU
    backend: nccl
    find_unused_parameters: false

  advanced_augmentation:
    enabled: false  # Future: Add data augmentation

  curriculum_learning:
    enabled: false  # Future: Start with easier samples

# ============================================================================
# Additional required configurations
# ============================================================================

# Debug settings
debug:
  detect_anomaly: false
  enabled: false
  fast_dev_run: 10
  profiler: false

# Project settings
project:
  deterministic: true
  name: ATFT-GAT-FAN-Optimized
  seed: 42

# Paths configuration
paths:
  data: data
  logs: logs
  models: models
  root: .

# Mode
mode: train
